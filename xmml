#!/usr/bin/env python

# Copyright 2011 Craig Campbell
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
import getopt, sys, os
from xmmllib.listener import Listener
from xmmllib.musicbox import MusicBox
from xmmllib.logger import Logger

def showUsage():
    print "usage"
    sys.exit(0)

try:
    opts, args = getopt.getopt(sys.argv[1:], "", ["verbose", "help", "watch="])
except:
    showUsage()

verbose = False
start = None
listen = False
file_list = {}
for key, value in opts:
    if key == "--help":
        showUsage()
    elif key == "--verbose":
        verbose = True
    elif key == "--watch":
        listen = True
        bits = value.split(':')
        start = bits[0]
        if len(bits) == 1:
            end = bits[0]
            continue;

        end = bits[1]

def isFileOrDirectory(path):
    return os.path.isfile(path) or os.path.isdir(path)

if len(args) >= 2 and isFileOrDirectory(args[0]):
    start = args[0]
    end = args[1]

if start is None:
    print "file or directory to watch is required"
    showUsage()

if not isFileOrDirectory(start):
    print start,"is not a file or directory"
    showUsage()

# try:
logger = Logger(verbose)
listener = Listener(logger)
musicbox = MusicBox(logger)
listener.onChange(musicbox.processFile)
if listen:
    listener.watch(start, end)
else:
    listener.process(start, end)
# except:
    # sys.exit(1)
    # pass
